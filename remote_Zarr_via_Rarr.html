<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Accessing Zarr archives using Rarr</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="remote_Zarr_via_Rarr_files/libs/clipboard/clipboard.min.js"></script>
<script src="remote_Zarr_via_Rarr_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="remote_Zarr_via_Rarr_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="remote_Zarr_via_Rarr_files/libs/quarto-html/popper.min.js"></script>
<script src="remote_Zarr_via_Rarr_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="remote_Zarr_via_Rarr_files/libs/quarto-html/anchor.min.js"></script>
<link href="remote_Zarr_via_Rarr_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="remote_Zarr_via_Rarr_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="remote_Zarr_via_Rarr_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="remote_Zarr_via_Rarr_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="remote_Zarr_via_Rarr_files/libs/bootstrap/bootstrap-7cb767a14c60d3560c64fbd99ff0b7ca.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Accessing Zarr archives using <code>Rarr</code></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level3">
<h3 class="anchored" data-anchor-id="introduction">Introduction</h3>
<p>This notebook demonstrates how to <strong>retrieve</strong> remotely stored Zarr data using the <code>Rarr</code> package in R. We will explore how to <strong>read</strong> Zarr data (zarrays) and their metadata. For subsequent analysis and visualization we turn the zarray into <code>stars</code> objects which are more suitable for spatial data.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>This notebook has a sibling, which demonstrates how to access the same Zarr data using the <code>Rarr</code> package. You can find it <a href="./remote_Zarr_via_GDAL.html">here</a>.</p>
</div>
</div>
</section>
<section id="what-we-will-learn" class="level3">
<h3 class="anchored" data-anchor-id="what-we-will-learn">What we will learn</h3>
<ul>
<li>‚úèÔ∏è How to edit URLs of Zarr archives to make them readable for GDAL</li>
<li>üîé Which read-functions and arguments to use in <code>stars</code> and <code>terra</code></li>
<li>üöß Current limitations of these packages</li>
</ul>
</section>
<section id="prerequisites" class="level3">
<h3 class="anchored" data-anchor-id="prerequisites">Prerequisites</h3>
<p>We start at the point where <strong>you already have found the URL</strong> of your remote Zarr archive. This can be achived, e.g., using STAC, and is demonstrated in other notebooks in this series like <a href="https://eopf-toolkit.github.io/eopf-101/51_eopf_stac_r.html">‚ÄúAccess the EOPF Zarr STAC API with R‚Äù</a>. Here we use the example STAC asset from the <a href="https://eopf-sample-service.github.io/eopf-sample-notebooks/sentinel-2-l1c-msi-zarr-product-exploration/#introduction">Sentinel-2 L1C MSI Zarr Product Exploration notebook</a> which is hosted on EODC‚Äôs object storage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>zarr_url <span class="ot">=</span> <span class="st">"https://objects.eodc.eu/e05ab01a9d56408d82ac32d69a5aae2a:sample-data/tutorial_data/cpm_v253/S2B_MSIL1C_20250113T103309_N0511_R108_T32TLQ_20250113T122458.zarr"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="import-packages" class="level3">
<h3 class="anchored" data-anchor-id="import-packages">Import packages</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Rarr)      <span class="co"># reading</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stars)     <span class="co"># spatial objects</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)     <span class="co"># table operations</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)  <span class="co"># parsing metadata</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mapview)   <span class="co"># interactive maps</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="metadata-exploration-with-rarr" class="level2">
<h2 class="anchored" data-anchor-id="metadata-exploration-with-rarr">Metadata exploration with Rarr</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this notebook we show the current capabilities and limitations of <code>Rarr</code> in terms of reading Zarr array(s) and their metadata. Successful attempts are marked with a ‚úÖ, failed attempts with a ‚õî.</p>
</div>
</div>
<p>Using the <code>Rarr::zarr_overview</code> function we can get meta data for all assets in the remote Zarr archive as a table. Here list all arrays and their data type, compression, dimensions, etc.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>zarr_content <span class="ot">=</span> <span class="fu">zarr_overview</span>(zarr_url, <span class="at">as_data_frame =</span> T) <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">var =</span> <span class="fu">sub</span>(zarr_url, <span class="st">""</span>, path)) <span class="sc">|&gt;</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(var, <span class="fu">everything</span>(), <span class="sc">-</span>path) </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">filter</span>(zarr_content, <span class="fu">grepl</span>(<span class="st">"reflectance"</span>, var))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                  var nchunks data_type compressor          dim
1  /measurements/reflectance/r10m/b02      36    uint16      blosc 10980, 10980
2  /measurements/reflectance/r10m/b03      36    uint16      blosc 10980, 10980
3  /measurements/reflectance/r10m/b04      36    uint16      blosc 10980, 10980
4  /measurements/reflectance/r10m/b08      36    uint16      blosc 10980, 10980
5    /measurements/reflectance/r10m/x       1     int64      blosc        10980
6    /measurements/reflectance/r10m/y       1     int64      blosc        10980
7  /measurements/reflectance/r20m/b05      36    uint16      blosc   5490, 5490
8  /measurements/reflectance/r20m/b06      36    uint16      blosc   5490, 5490
9  /measurements/reflectance/r20m/b07      36    uint16      blosc   5490, 5490
10 /measurements/reflectance/r20m/b11      36    uint16      blosc   5490, 5490
11 /measurements/reflectance/r20m/b12      36    uint16      blosc   5490, 5490
12 /measurements/reflectance/r20m/b8a      36    uint16      blosc   5490, 5490
13   /measurements/reflectance/r20m/x       1     int64      blosc         5490
14   /measurements/reflectance/r20m/y       1     int64      blosc         5490
15 /measurements/reflectance/r60m/b01      36    uint16      blosc   1830, 1830
16 /measurements/reflectance/r60m/b09      36    uint16      blosc   1830, 1830
17 /measurements/reflectance/r60m/b10      36    uint16      blosc   1830, 1830
18   /measurements/reflectance/r60m/x       1     int64      blosc         1830
19   /measurements/reflectance/r60m/y       1     int64      blosc         1830
    chunk_dim
1  1830, 1830
2  1830, 1830
3  1830, 1830
4  1830, 1830
5       10980
6       10980
7    915, 915
8    915, 915
9    915, 915
10   915, 915
11   915, 915
12   915, 915
13       5490
14       5490
15   305, 305
16   305, 305
17   305, 305
18       1830
19       1830</code></pre>
</div>
</div>
<p>We can see that all Sentinel-2 bands are in the archive, but split into directories based on spatial resolution (10, 20, 60 meters), which have different dimensions (number and size of pixels).</p>
<a data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample" href=""> Click to show the full Zarr archive content </a> <br>
<div id="collapseExample" class="collapse">
<div class="card card-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(zarr_content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                   var nchunks  data_type
1                           /conditions/geometry/angle       1 unicode224
2                            /conditions/geometry/band       1  unicode96
3                        /conditions/geometry/detector       1      int64
4                 /conditions/geometry/mean_sun_angles       1    float64
5   /conditions/geometry/mean_viewing_incidence_angles       1    float64
6                      /conditions/geometry/sun_angles       1    float64
7        /conditions/geometry/viewing_incidence_angles       4    float64
8                               /conditions/geometry/x       1      int64
9                               /conditions/geometry/y       1      int64
10        /conditions/mask/detector_footprint/r10m/b02      36      uint8
11        /conditions/mask/detector_footprint/r10m/b03      36      uint8
12        /conditions/mask/detector_footprint/r10m/b04      36      uint8
13        /conditions/mask/detector_footprint/r10m/b08      36      uint8
14          /conditions/mask/detector_footprint/r10m/x       1      int64
15          /conditions/mask/detector_footprint/r10m/y       1      int64
16        /conditions/mask/detector_footprint/r20m/b05      36      uint8
17        /conditions/mask/detector_footprint/r20m/b06      36      uint8
18        /conditions/mask/detector_footprint/r20m/b07      36      uint8
19        /conditions/mask/detector_footprint/r20m/b11      36      uint8
20        /conditions/mask/detector_footprint/r20m/b12      36      uint8
21        /conditions/mask/detector_footprint/r20m/b8a      36      uint8
22          /conditions/mask/detector_footprint/r20m/x       1      int64
23          /conditions/mask/detector_footprint/r20m/y       1      int64
24        /conditions/mask/detector_footprint/r60m/b01      36      uint8
25        /conditions/mask/detector_footprint/r60m/b09      36      uint8
26        /conditions/mask/detector_footprint/r60m/b10      36      uint8
27          /conditions/mask/detector_footprint/r60m/x       1      int64
28          /conditions/mask/detector_footprint/r60m/y       1      int64
29        /conditions/mask/l1c_classification/r60m/b00      36      uint8
30          /conditions/mask/l1c_classification/r60m/x       1      int64
31          /conditions/mask/l1c_classification/r60m/y       1      int64
32                /conditions/meteorology/cams/aod1240       1    float32
33                 /conditions/meteorology/cams/aod469       1    float32
34                 /conditions/meteorology/cams/aod550       1    float32
35                 /conditions/meteorology/cams/aod670       1    float32
36                 /conditions/meteorology/cams/aod865       1    float32
37               /conditions/meteorology/cams/bcaod550       1    float32
38               /conditions/meteorology/cams/duaod550       1    float32
39          /conditions/meteorology/cams/isobaricInhPa       1    float64
40               /conditions/meteorology/cams/latitude       1    float64
41              /conditions/meteorology/cams/longitude       1    float64
42                 /conditions/meteorology/cams/number       1      int64
43               /conditions/meteorology/cams/omaod550       1    float32
44               /conditions/meteorology/cams/ssaod550       1    float32
45                   /conditions/meteorology/cams/step       1      int64
46               /conditions/meteorology/cams/suaod550       1    float32
47                /conditions/meteorology/cams/surface       1    float64
48                   /conditions/meteorology/cams/time       1      int64
49             /conditions/meteorology/cams/valid_time       1      int64
50                      /conditions/meteorology/cams/z       1    float32
51         /conditions/meteorology/ecmwf/isobaricInhPa       1    float64
52              /conditions/meteorology/ecmwf/latitude       1    float64
53             /conditions/meteorology/ecmwf/longitude       1    float64
54                   /conditions/meteorology/ecmwf/msl       1    float32
55                /conditions/meteorology/ecmwf/number       1      int64
56                     /conditions/meteorology/ecmwf/r       1    float32
57                  /conditions/meteorology/ecmwf/step       1      int64
58               /conditions/meteorology/ecmwf/surface       1    float64
59                  /conditions/meteorology/ecmwf/tco3       1    float32
60                  /conditions/meteorology/ecmwf/tcwv       1    float32
61                  /conditions/meteorology/ecmwf/time       1      int64
62                   /conditions/meteorology/ecmwf/u10       1    float32
63                   /conditions/meteorology/ecmwf/v10       1    float32
64            /conditions/meteorology/ecmwf/valid_time       1      int64
65                  /measurements/reflectance/r10m/b02      36     uint16
66                  /measurements/reflectance/r10m/b03      36     uint16
67                  /measurements/reflectance/r10m/b04      36     uint16
68                  /measurements/reflectance/r10m/b08      36     uint16
69                    /measurements/reflectance/r10m/x       1      int64
70                    /measurements/reflectance/r10m/y       1      int64
71                  /measurements/reflectance/r20m/b05      36     uint16
72                  /measurements/reflectance/r20m/b06      36     uint16
73                  /measurements/reflectance/r20m/b07      36     uint16
74                  /measurements/reflectance/r20m/b11      36     uint16
75                  /measurements/reflectance/r20m/b12      36     uint16
76                  /measurements/reflectance/r20m/b8a      36     uint16
77                    /measurements/reflectance/r20m/x       1      int64
78                    /measurements/reflectance/r20m/y       1      int64
79                  /measurements/reflectance/r60m/b01      36     uint16
80                  /measurements/reflectance/r60m/b09      36     uint16
81                  /measurements/reflectance/r60m/b10      36     uint16
82                    /measurements/reflectance/r60m/x       1      int64
83                    /measurements/reflectance/r60m/y       1      int64
84                    /quality/l1c_quicklook/r10m/band       1      int64
85                     /quality/l1c_quicklook/r10m/tci     108      uint8
86                       /quality/l1c_quicklook/r10m/x       1      int64
87                       /quality/l1c_quicklook/r10m/y       1      int64
88                              /quality/mask/r10m/b02      36      uint8
89                              /quality/mask/r10m/b03      36      uint8
90                              /quality/mask/r10m/b04      36      uint8
91                              /quality/mask/r10m/b08      36      uint8
92                                /quality/mask/r10m/x       1      int64
93                                /quality/mask/r10m/y       1      int64
94                              /quality/mask/r20m/b05      36      uint8
95                              /quality/mask/r20m/b06      36      uint8
96                              /quality/mask/r20m/b07      36      uint8
97                              /quality/mask/r20m/b11      36      uint8
98                              /quality/mask/r20m/b12      36      uint8
99                              /quality/mask/r20m/b8a      36      uint8
100                               /quality/mask/r20m/x       1      int64
101                               /quality/mask/r20m/y       1      int64
102                             /quality/mask/r60m/b01      36      uint8
103                             /quality/mask/r60m/b09      36      uint8
104                             /quality/mask/r60m/b10      36      uint8
105                               /quality/mask/r60m/x       1      int64
106                               /quality/mask/r60m/y       1      int64
    compressor          dim    chunk_dim
1        blosc            2            2
2        blosc           13           13
3        blosc            7            7
4        blosc            2            2
5        blosc        13, 2        13, 2
6        blosc    2, 23, 23    2, 23, 23
7        blosc 13, 7, 2.... 7, 4, 2,....
8        blosc           23           23
9        blosc           23           23
10       blosc 10980, 10980   1830, 1830
11       blosc 10980, 10980   1830, 1830
12       blosc 10980, 10980   1830, 1830
13       blosc 10980, 10980   1830, 1830
14       blosc        10980        10980
15       blosc        10980        10980
16       blosc   5490, 5490     915, 915
17       blosc   5490, 5490     915, 915
18       blosc   5490, 5490     915, 915
19       blosc   5490, 5490     915, 915
20       blosc   5490, 5490     915, 915
21       blosc   5490, 5490     915, 915
22       blosc         5490         5490
23       blosc         5490         5490
24       blosc   1830, 1830     305, 305
25       blosc   1830, 1830     305, 305
26       blosc   1830, 1830     305, 305
27       blosc         1830         1830
28       blosc         1830         1830
29       blosc   1830, 1830     305, 305
30       blosc         1830         1830
31       blosc         1830         1830
32       blosc         9, 9         9, 9
33       blosc         9, 9         9, 9
34       blosc         9, 9         9, 9
35       blosc         9, 9         9, 9
36       blosc         9, 9         9, 9
37       blosc         9, 9         9, 9
38       blosc         9, 9         9, 9
39        &lt;NA&gt;                          
40       blosc            9            9
41       blosc            9            9
42        &lt;NA&gt;                          
43       blosc         9, 9         9, 9
44       blosc         9, 9         9, 9
45        &lt;NA&gt;                          
46       blosc         9, 9         9, 9
47        &lt;NA&gt;                          
48        &lt;NA&gt;                          
49        &lt;NA&gt;                          
50       blosc         9, 9         9, 9
51        &lt;NA&gt;                          
52       blosc            9            9
53       blosc            9            9
54       blosc         9, 9         9, 9
55        &lt;NA&gt;                          
56       blosc         9, 9         9, 9
57        &lt;NA&gt;                          
58        &lt;NA&gt;                          
59       blosc         9, 9         9, 9
60       blosc         9, 9         9, 9
61        &lt;NA&gt;                          
62       blosc         9, 9         9, 9
63       blosc         9, 9         9, 9
64        &lt;NA&gt;                          
65       blosc 10980, 10980   1830, 1830
66       blosc 10980, 10980   1830, 1830
67       blosc 10980, 10980   1830, 1830
68       blosc 10980, 10980   1830, 1830
69       blosc        10980        10980
70       blosc        10980        10980
71       blosc   5490, 5490     915, 915
72       blosc   5490, 5490     915, 915
73       blosc   5490, 5490     915, 915
74       blosc   5490, 5490     915, 915
75       blosc   5490, 5490     915, 915
76       blosc   5490, 5490     915, 915
77       blosc         5490         5490
78       blosc         5490         5490
79       blosc   1830, 1830     305, 305
80       blosc   1830, 1830     305, 305
81       blosc   1830, 1830     305, 305
82       blosc         1830         1830
83       blosc         1830         1830
84       blosc            3            3
85       blosc 3, 10980.... 1, 1830,....
86       blosc        10980        10980
87       blosc        10980        10980
88       blosc 10980, 10980   1830, 1830
89       blosc 10980, 10980   1830, 1830
90       blosc 10980, 10980   1830, 1830
91       blosc 10980, 10980   1830, 1830
92       blosc        10980        10980
93       blosc        10980        10980
94       blosc   5490, 5490     915, 915
95       blosc   5490, 5490     915, 915
96       blosc   5490, 5490     915, 915
97       blosc   5490, 5490     915, 915
98       blosc   5490, 5490     915, 915
99       blosc   5490, 5490     915, 915
100      blosc         5490         5490
101      blosc         5490         5490
102      blosc   1830, 1830     305, 305
103      blosc   1830, 1830     305, 305
104      blosc   1830, 1830     305, 305
105      blosc         1830         1830
106      blosc         1830         1830</code></pre>
</div>
</div>
</div>
</div>
<p>Now that we have an overview of the content, let‚Äôs get some related metadata. <code>Rarr</code> provides the <code>read_zattrs</code> function for this purpose, which looks for the <code>.zattrs</code> file inside the archive.</p>
<p>‚õî Unfortunately we were not successful when applying it to our remote archive.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_zattrs</span>(zarr_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in read_zattrs(zarr_url): The group or array does not contain attributes (.zattrs)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_zattrs</span>(<span class="fu">file.path</span>(zarr_url, <span class="st">".zattrs"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in read_zattrs(file.path(zarr_url, ".zattrs")): The group or array does not contain attributes (.zattrs)</code></pre>
</div>
</div>
<p>‚úÖ As a simple workaround we can read the JSON directly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>zattrs <span class="ot">=</span> <span class="fu">read_json</span>(<span class="fu">file.path</span>(zarr_url, <span class="st">".zattrs"</span>))</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(zattrs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "other_metadata"  "other_metadata4" "stac_discovery" </code></pre>
</div>
</div>
<a data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample" href=""> Click to show full Zarr archive metadata </a> <br>
<div id="collapseExample" class="collapse">
<div class="card card-body">
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(zarr_content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                   var nchunks  data_type
1                           /conditions/geometry/angle       1 unicode224
2                            /conditions/geometry/band       1  unicode96
3                        /conditions/geometry/detector       1      int64
4                 /conditions/geometry/mean_sun_angles       1    float64
5   /conditions/geometry/mean_viewing_incidence_angles       1    float64
6                      /conditions/geometry/sun_angles       1    float64
7        /conditions/geometry/viewing_incidence_angles       4    float64
8                               /conditions/geometry/x       1      int64
9                               /conditions/geometry/y       1      int64
10        /conditions/mask/detector_footprint/r10m/b02      36      uint8
11        /conditions/mask/detector_footprint/r10m/b03      36      uint8
12        /conditions/mask/detector_footprint/r10m/b04      36      uint8
13        /conditions/mask/detector_footprint/r10m/b08      36      uint8
14          /conditions/mask/detector_footprint/r10m/x       1      int64
15          /conditions/mask/detector_footprint/r10m/y       1      int64
16        /conditions/mask/detector_footprint/r20m/b05      36      uint8
17        /conditions/mask/detector_footprint/r20m/b06      36      uint8
18        /conditions/mask/detector_footprint/r20m/b07      36      uint8
19        /conditions/mask/detector_footprint/r20m/b11      36      uint8
20        /conditions/mask/detector_footprint/r20m/b12      36      uint8
21        /conditions/mask/detector_footprint/r20m/b8a      36      uint8
22          /conditions/mask/detector_footprint/r20m/x       1      int64
23          /conditions/mask/detector_footprint/r20m/y       1      int64
24        /conditions/mask/detector_footprint/r60m/b01      36      uint8
25        /conditions/mask/detector_footprint/r60m/b09      36      uint8
26        /conditions/mask/detector_footprint/r60m/b10      36      uint8
27          /conditions/mask/detector_footprint/r60m/x       1      int64
28          /conditions/mask/detector_footprint/r60m/y       1      int64
29        /conditions/mask/l1c_classification/r60m/b00      36      uint8
30          /conditions/mask/l1c_classification/r60m/x       1      int64
31          /conditions/mask/l1c_classification/r60m/y       1      int64
32                /conditions/meteorology/cams/aod1240       1    float32
33                 /conditions/meteorology/cams/aod469       1    float32
34                 /conditions/meteorology/cams/aod550       1    float32
35                 /conditions/meteorology/cams/aod670       1    float32
36                 /conditions/meteorology/cams/aod865       1    float32
37               /conditions/meteorology/cams/bcaod550       1    float32
38               /conditions/meteorology/cams/duaod550       1    float32
39          /conditions/meteorology/cams/isobaricInhPa       1    float64
40               /conditions/meteorology/cams/latitude       1    float64
41              /conditions/meteorology/cams/longitude       1    float64
42                 /conditions/meteorology/cams/number       1      int64
43               /conditions/meteorology/cams/omaod550       1    float32
44               /conditions/meteorology/cams/ssaod550       1    float32
45                   /conditions/meteorology/cams/step       1      int64
46               /conditions/meteorology/cams/suaod550       1    float32
47                /conditions/meteorology/cams/surface       1    float64
48                   /conditions/meteorology/cams/time       1      int64
49             /conditions/meteorology/cams/valid_time       1      int64
50                      /conditions/meteorology/cams/z       1    float32
51         /conditions/meteorology/ecmwf/isobaricInhPa       1    float64
52              /conditions/meteorology/ecmwf/latitude       1    float64
53             /conditions/meteorology/ecmwf/longitude       1    float64
54                   /conditions/meteorology/ecmwf/msl       1    float32
55                /conditions/meteorology/ecmwf/number       1      int64
56                     /conditions/meteorology/ecmwf/r       1    float32
57                  /conditions/meteorology/ecmwf/step       1      int64
58               /conditions/meteorology/ecmwf/surface       1    float64
59                  /conditions/meteorology/ecmwf/tco3       1    float32
60                  /conditions/meteorology/ecmwf/tcwv       1    float32
61                  /conditions/meteorology/ecmwf/time       1      int64
62                   /conditions/meteorology/ecmwf/u10       1    float32
63                   /conditions/meteorology/ecmwf/v10       1    float32
64            /conditions/meteorology/ecmwf/valid_time       1      int64
65                  /measurements/reflectance/r10m/b02      36     uint16
66                  /measurements/reflectance/r10m/b03      36     uint16
67                  /measurements/reflectance/r10m/b04      36     uint16
68                  /measurements/reflectance/r10m/b08      36     uint16
69                    /measurements/reflectance/r10m/x       1      int64
70                    /measurements/reflectance/r10m/y       1      int64
71                  /measurements/reflectance/r20m/b05      36     uint16
72                  /measurements/reflectance/r20m/b06      36     uint16
73                  /measurements/reflectance/r20m/b07      36     uint16
74                  /measurements/reflectance/r20m/b11      36     uint16
75                  /measurements/reflectance/r20m/b12      36     uint16
76                  /measurements/reflectance/r20m/b8a      36     uint16
77                    /measurements/reflectance/r20m/x       1      int64
78                    /measurements/reflectance/r20m/y       1      int64
79                  /measurements/reflectance/r60m/b01      36     uint16
80                  /measurements/reflectance/r60m/b09      36     uint16
81                  /measurements/reflectance/r60m/b10      36     uint16
82                    /measurements/reflectance/r60m/x       1      int64
83                    /measurements/reflectance/r60m/y       1      int64
84                    /quality/l1c_quicklook/r10m/band       1      int64
85                     /quality/l1c_quicklook/r10m/tci     108      uint8
86                       /quality/l1c_quicklook/r10m/x       1      int64
87                       /quality/l1c_quicklook/r10m/y       1      int64
88                              /quality/mask/r10m/b02      36      uint8
89                              /quality/mask/r10m/b03      36      uint8
90                              /quality/mask/r10m/b04      36      uint8
91                              /quality/mask/r10m/b08      36      uint8
92                                /quality/mask/r10m/x       1      int64
93                                /quality/mask/r10m/y       1      int64
94                              /quality/mask/r20m/b05      36      uint8
95                              /quality/mask/r20m/b06      36      uint8
96                              /quality/mask/r20m/b07      36      uint8
97                              /quality/mask/r20m/b11      36      uint8
98                              /quality/mask/r20m/b12      36      uint8
99                              /quality/mask/r20m/b8a      36      uint8
100                               /quality/mask/r20m/x       1      int64
101                               /quality/mask/r20m/y       1      int64
102                             /quality/mask/r60m/b01      36      uint8
103                             /quality/mask/r60m/b09      36      uint8
104                             /quality/mask/r60m/b10      36      uint8
105                               /quality/mask/r60m/x       1      int64
106                               /quality/mask/r60m/y       1      int64
    compressor          dim    chunk_dim
1        blosc            2            2
2        blosc           13           13
3        blosc            7            7
4        blosc            2            2
5        blosc        13, 2        13, 2
6        blosc    2, 23, 23    2, 23, 23
7        blosc 13, 7, 2.... 7, 4, 2,....
8        blosc           23           23
9        blosc           23           23
10       blosc 10980, 10980   1830, 1830
11       blosc 10980, 10980   1830, 1830
12       blosc 10980, 10980   1830, 1830
13       blosc 10980, 10980   1830, 1830
14       blosc        10980        10980
15       blosc        10980        10980
16       blosc   5490, 5490     915, 915
17       blosc   5490, 5490     915, 915
18       blosc   5490, 5490     915, 915
19       blosc   5490, 5490     915, 915
20       blosc   5490, 5490     915, 915
21       blosc   5490, 5490     915, 915
22       blosc         5490         5490
23       blosc         5490         5490
24       blosc   1830, 1830     305, 305
25       blosc   1830, 1830     305, 305
26       blosc   1830, 1830     305, 305
27       blosc         1830         1830
28       blosc         1830         1830
29       blosc   1830, 1830     305, 305
30       blosc         1830         1830
31       blosc         1830         1830
32       blosc         9, 9         9, 9
33       blosc         9, 9         9, 9
34       blosc         9, 9         9, 9
35       blosc         9, 9         9, 9
36       blosc         9, 9         9, 9
37       blosc         9, 9         9, 9
38       blosc         9, 9         9, 9
39        &lt;NA&gt;                          
40       blosc            9            9
41       blosc            9            9
42        &lt;NA&gt;                          
43       blosc         9, 9         9, 9
44       blosc         9, 9         9, 9
45        &lt;NA&gt;                          
46       blosc         9, 9         9, 9
47        &lt;NA&gt;                          
48        &lt;NA&gt;                          
49        &lt;NA&gt;                          
50       blosc         9, 9         9, 9
51        &lt;NA&gt;                          
52       blosc            9            9
53       blosc            9            9
54       blosc         9, 9         9, 9
55        &lt;NA&gt;                          
56       blosc         9, 9         9, 9
57        &lt;NA&gt;                          
58        &lt;NA&gt;                          
59       blosc         9, 9         9, 9
60       blosc         9, 9         9, 9
61        &lt;NA&gt;                          
62       blosc         9, 9         9, 9
63       blosc         9, 9         9, 9
64        &lt;NA&gt;                          
65       blosc 10980, 10980   1830, 1830
66       blosc 10980, 10980   1830, 1830
67       blosc 10980, 10980   1830, 1830
68       blosc 10980, 10980   1830, 1830
69       blosc        10980        10980
70       blosc        10980        10980
71       blosc   5490, 5490     915, 915
72       blosc   5490, 5490     915, 915
73       blosc   5490, 5490     915, 915
74       blosc   5490, 5490     915, 915
75       blosc   5490, 5490     915, 915
76       blosc   5490, 5490     915, 915
77       blosc         5490         5490
78       blosc         5490         5490
79       blosc   1830, 1830     305, 305
80       blosc   1830, 1830     305, 305
81       blosc   1830, 1830     305, 305
82       blosc         1830         1830
83       blosc         1830         1830
84       blosc            3            3
85       blosc 3, 10980.... 1, 1830,....
86       blosc        10980        10980
87       blosc        10980        10980
88       blosc 10980, 10980   1830, 1830
89       blosc 10980, 10980   1830, 1830
90       blosc 10980, 10980   1830, 1830
91       blosc 10980, 10980   1830, 1830
92       blosc        10980        10980
93       blosc        10980        10980
94       blosc   5490, 5490     915, 915
95       blosc   5490, 5490     915, 915
96       blosc   5490, 5490     915, 915
97       blosc   5490, 5490     915, 915
98       blosc   5490, 5490     915, 915
99       blosc   5490, 5490     915, 915
100      blosc         5490         5490
101      blosc         5490         5490
102      blosc   1830, 1830     305, 305
103      blosc   1830, 1830     305, 305
104      blosc   1830, 1830     305, 305
105      blosc         1830         1830
106      blosc         1830         1830</code></pre>
</div>
</div>
</div>
</div>
<p>The same information can be retrieved with <code>sf::gdal_utils('mdiminfo', ...)</code>.</p>
</section>
<section id="reading-zarr-data-with-rarr" class="level2">
<h2 class="anchored" data-anchor-id="reading-zarr-data-with-rarr">Reading Zarr data with <code>Rarr</code></h2>
<p>‚õî <code>Rarr</code>, like <code>stars</code> and <code>terra</code>, is not capable of reading multiple arrays from the remote archive simultaneously.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">read_zarr_array</span>(zarr_url)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: </code></pre>
</div>
</div>
<p>‚úÖ But if a single band array is selected it works.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>band_variable <span class="ot">=</span> <span class="st">"/measurements/reflectance/r60m/b01"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>zarray <span class="ot">=</span> <span class="fu">read_zarr_array</span>(<span class="fu">paste0</span>(zarr_url, band_variable))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(zarray)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> int [1:1830, 1:1830] 9548 8117 7158 5906 7007 7523 5999 6570 7165 6666 ...</code></pre>
</div>
</div>
<p>However, the function returen a matrix lacking any spatial metadata (e.g.&nbsp;CRS) or coordinates. Careful, the array has flipped dimensions! But we can access X and Y coordinates for each pixel seperately.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>zarray_60m_x <span class="ot">=</span> <span class="fu">paste0</span>(zarr_url, <span class="st">"/measurements/reflectance/r60m/x"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_zarr_array</span>()</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>zarray_60m_y <span class="ot">=</span> <span class="fu">paste0</span>(zarr_url, <span class="st">"/measurements/reflectance/r60m/y"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_zarr_array</span>()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">range</span>(zarray_60m_x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 300030 409770</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">range</span>(zarray_60m_y))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4890270 5000010</code></pre>
</div>
</div>
<p>Let‚Äôs construct a stars object from the components found in the Zarr archive: - data array - X and Y coordinates - CRS (from metadata)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># read CRS from attributes</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>zarr_crs <span class="ot">=</span> zattrs<span class="sc">$</span>stac_discovery<span class="sc">$</span>properties<span class="sc">$</span><span class="st">`</span><span class="at">proj:epsg</span><span class="st">`</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># band name</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>var <span class="ot">=</span> <span class="fu">basename</span>(band_variable)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a><span class="co"># read and transpose matrix before converting to stars</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>zz <span class="ot">=</span> <span class="fu">st_as_stars</span>(zarray <span class="sc">|&gt;</span> <span class="fu">t</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_dimensions</span>(<span class="dv">1</span>, <span class="at">names =</span> <span class="st">"X"</span>, <span class="at">values =</span> zarray_60m_x) <span class="sc">|&gt;</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_set_dimensions</span>(<span class="dv">2</span>, <span class="at">names =</span> <span class="st">"Y"</span>, <span class="at">values =</span> zarray_60m_y) <span class="sc">|&gt;</span> </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(var)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a><span class="fu">st_crs</span>(zz) <span class="ot">=</span> <span class="fu">st_crs</span>(zarr_crs)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>zz</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stars object with 2 dimensions and 1 attribute
attribute(s), summary of first 1e+05 cells:
     Min. 1st Qu. Median     Mean 3rd Qu.  Max.
b01  2299    2542   2628 4541.124    5304 17556
dimension(s):
  from   to  offset delta                refsys point x/y
X    1 1830  300030    60 WGS 84 / UTM zone 32N FALSE [x]
Y    1 1830 5000010   -60 WGS 84 / UTM zone 32N FALSE [y]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(zz, <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="remote_Zarr_via_Rarr_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>all in one function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>st_read_zarray <span class="ot">=</span> <span class="cf">function</span>(path, var, res, ...){</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stopifnot valid zarr url / variable / resolution ...</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># get metadata including CRS</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  zattrs <span class="ot">=</span> jsonlite<span class="sc">::</span><span class="fu">read_json</span>(<span class="fu">file.path</span>(path, <span class="st">".zattrs"</span>))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  zarr_crs <span class="ot">=</span> zattrs<span class="sc">$</span>stac_discovery<span class="sc">$</span>properties<span class="sc">$</span><span class="st">`</span><span class="at">proj:epsg</span><span class="st">`</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># zattrs$stac_discovery$properties$`eopf:resolutions`</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  res_char <span class="ot">=</span> <span class="cf">switch</span>(<span class="fu">as.character</span>(res),</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"10"</span> <span class="ot">=</span> <span class="st">"r10m"</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"20"</span> <span class="ot">=</span> <span class="st">"r20m"</span>, </span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"60"</span> <span class="ot">=</span> <span class="st">"r60m"</span>,</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Resolution must be one of 10, 20, or 60."</span>)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...: make use of index arguments of read_zarr_array??</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  zarray <span class="ot">=</span> <span class="fu">file.path</span>(path, <span class="st">"measurements/reflectance"</span>, res_char, var) <span class="sc">|&gt;</span> </span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_zarr_array</span>(...)</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  zarray_x <span class="ot">=</span> <span class="fu">file.path</span>(path, <span class="st">"measurements/reflectance"</span>, res_char, <span class="st">"x"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_zarr_array</span>(...)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  zarray_y <span class="ot">=</span> <span class="fu">file.path</span>(path, <span class="st">"measurements/reflectance"</span>, res_char, <span class="st">"y"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">read_zarr_array</span>(...)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># transpose matrixe before converting to stars</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  z <span class="ot">=</span> zarray <span class="sc">|&gt;</span> </span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">t</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_as_stars</span>() <span class="sc">|&gt;</span> </span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">#st_set_crs(st_crs(zarr_crs)) |&gt;   # does not seem to work in the pipeline.</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_set_dimensions</span>(<span class="dv">1</span>, <span class="at">names =</span> <span class="st">"X"</span>, <span class="at">values =</span> zarray_x) <span class="sc">|&gt;</span> </span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_set_dimensions</span>(<span class="dv">2</span>, <span class="at">names =</span> <span class="st">"Y"</span>, <span class="at">values =</span> zarray_y) <span class="sc">|&gt;</span> </span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">setNames</span>(var)</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_crs</span>(z) <span class="ot">=</span> <span class="fu">st_crs</span>(zarr_crs)</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(z)</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="read-and-combine-multiple-zarrays" class="level2">
<h2 class="anchored" data-anchor-id="read-and-combine-multiple-zarrays">Read and combine multiple zarrays</h2>
<p>‚úÖ Now we can read multiple bands, combine to a single multi-band object, and visualize them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  b01 <span class="ot">=</span> <span class="fu">st_read_zarray</span>(zarr_url, <span class="st">"b01"</span>, <span class="dv">60</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  b09 <span class="ot">=</span> <span class="fu">st_read_zarray</span>(zarr_url, <span class="st">"b09"</span>, <span class="dv">60</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  (<span class="at">multi_band =</span> <span class="fu">c</span>(b01, b09) <span class="sc">|&gt;</span> <span class="fu">merge</span>())</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 17.071   0.634  30.394 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(multi_band, <span class="at">axes =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>downsample set to 1</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="remote_Zarr_via_Rarr_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="benchmark" class="level2">
<h2 class="anchored" data-anchor-id="benchmark">Benchmark</h2>
<p>What is faster and/or more efficient - GDAL or Rarr?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>vsi_prefix <span class="ot">=</span> <span class="st">"ZARR:/vsicurl/"</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>vsi_url <span class="ot">=</span> <span class="fu">paste0</span>(vsi_prefix, dplyr<span class="sc">::</span><span class="fu">as_label</span>(zarr_url)) </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>f_stars <span class="ot">=</span> <span class="cf">function</span>(){rs <span class="ot">=</span> <span class="fu">read_stars</span>(<span class="fu">paste</span>(vsi_url, band_variable, <span class="at">sep =</span> <span class="st">":"</span>))}</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>f_mdim <span class="ot">=</span> <span class="cf">function</span>(){sm <span class="ot">=</span> <span class="fu">read_mdim</span>(vsi_url, band_variable, <span class="at">proxy =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setNames</span>(<span class="fu">basename</span>(band_variable))}</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>f_rast <span class="ot">=</span> <span class="cf">function</span>(){tr <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">rast</span>(vsi_url, band_variable) <span class="sc">|&gt;</span> terra<span class="sc">::</span><span class="fu">toMemory</span>()}</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>f_rarr <span class="ot">=</span> <span class="cf">function</span>(){rr <span class="ot">=</span> <span class="fu">st_read_zarray</span>(zarr_url, <span class="st">"b01"</span>, <span class="dv">60</span>)}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>bench<span class="sc">::</span><span class="fu">mark</span>(<span class="fu">f_stars</span>(), <span class="fu">f_mdim</span>(), <span class="fu">f_rast</span>(), <span class="fu">f_rarr</span>(), </span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> F, <span class="at">iterations =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 √ó 6
  expression      min   median `itr/sec` mem_alloc `gc/sec`
  &lt;bch:expr&gt; &lt;bch:tm&gt; &lt;bch:tm&gt;     &lt;dbl&gt; &lt;bch:byt&gt;    &lt;dbl&gt;
1 f_stars()     11.5s    11.6s    0.0858      26MB   0     
2 f_mdim()      11.1s    11.5s    0.0866    26.1MB   0.0217
3 f_rast()      11.5s    11.9s    0.0843    88.1KB   0     
4 f_rarr()      12.4s    12.4s    0.0805   108.9MB   0.322 </code></pre>
</div>
</div>
<p>The benchmark does not reveal a clear winner in terms of speed. However, <code>Rarr</code> seems to allocate more memory compared to <code>stars</code> and <code>terra</code>.</p>
</section>
<section id="now-it-is-your-turn" class="level2">
<h2 class="anchored" data-anchor-id="now-it-is-your-turn">üí™ Now it is your turn</h2>
<ul>
<li>üî≠ <strong>Task</strong>: Supply more arguments to <code>st_read_zarray</code> and pass a subset to read only parts on an array.</li>
<li>üíæ <strong>Task</strong>: Try writing zarrays to disk using <code>Rarr::write_zarr_array()</code></li>
<li>Read the <a href="https://huber-group-embl.github.io/Rarr/articles/Rarr.html">Rarr documentation</a>.</li>
</ul>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>In this notebook we have demonstrated how to access remote Zarr archives in R using the <code>Rarr</code> package. We have seen that it is possible to read specific data arrays, but <code>read_zarr_array</code> lacks the ability of accessing anything other than the raw array. To combine it with a CRS or coordinates we need to leverage a spatial class like <code>stars</code> and manually set the relevant metadata.</p>
</section>
<section id="whats-next" class="level2">
<h2 class="anchored" data-anchor-id="whats-next">What‚Äôs next?</h2>
<p>Further tests should evaluate wether data retrieved via <code>Rarr</code> versus GDAL are identical in terms of spatial extent and offset.</p>
<p>Explore <a href="./remote_Zarr_via_GDAL.html">this related notebook</a> which demonstrates how to access the same Zarr data using the GDAL Zarr driver via the <code>stars</code> and <code>terra</code> packages.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>